name: Deploy to Salesforce

on:
  pull_request:
    branches:
      - DevMain
      - UAT
      - Production

env:
  SF_API_VERSION: '64.0'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf --version

      - name: Install sfdx-git-delta
        run: echo "y" | sf plugins install sfdx-git-delta

      - name: Authenticate Org
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"

          case "$BASE_BRANCH" in
            "DevMain")  AUTH_URL="${{ secrets.SFDX_AUTH_URL_DEV }}" ;;
            "UAT")      AUTH_URL="${{ secrets.SFDX_AUTH_URL_UAT }}" ;;
            "Production") AUTH_URL="${{ secrets.SFDX_AUTH_URL_PROD }}" ;;
          esac

          echo "$AUTH_URL" > sfdx_auth_url.txt
          sf org login sfdx-url --sfdx-url-file sfdx_auth_url.txt --alias target-org --set-default
          rm sfdx_auth_url.txt

      - name: Generate Delta and Deploy
        run: |
          sf sgd source delta -f HEAD^ --output . -i .gitignore

          echo "=== Package Contents ==="
          cat package/package.xml

          echo "=== Destructive Changes ==="
          cat destructiveChanges/destructiveChanges.xml

          sf project deploy start \
            --manifest package/package.xml \
            --post-destructive-changes destructiveChanges/destructiveChanges.xml \
            --ignore-warnings \
            --target-org target-org \
            --api-version ${{ env.SF_API_VERSION }}
