name: Handle /approve Command

on:
  issue_comment:
    types: [created]

permissions:
  actions: write
  contents: read
  issues: write
  pull-requests: write

jobs:
  trigger-deployment:
    # Only run when someone comments "/approve" on a pull request
    if: >-
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    steps:
      - name: Get PR details and trigger deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;

            // Get PR details to check target branch
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const baseBranch = pr.data.base.ref;

            if (baseBranch !== 'UAT' && baseBranch !== 'Production') {
              console.log(`PR targets ${baseBranch}, not UAT or Production. Skipping.`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `‚ö†Ô∏è \`/approve\` command only works for PRs targeting **UAT** or **Production**. This PR targets **${baseBranch}**.`
              });
              return;
            }

            // Trigger the deploy-on-approval workflow via workflow_dispatch
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-on-approval.yml',
              ref: baseBranch,
              inputs: {
                pr_number: String(prNumber)
              }
            });

            console.log(`Triggered deployment workflow for PR #${prNumber} targeting ${baseBranch}`);

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `üöÄ **Deployment triggered via \`/approve\`**\n\nValidation and deployment workflow has been started for PR #${prNumber} targeting **${baseBranch}**.\n\nCheck the [Actions tab](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions) for progress.`
            });
